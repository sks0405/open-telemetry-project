name: product-catalog-ci

on:
  push:
    branches:
      - main

jobs:
  build-test-scan-push:
    runs-on: self-hosted

    steps:
      # -------------------------------
      # 1. Checkout source code
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------
      # 2. Setup Go with caching
      # -------------------------------
      - name: Setup Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: 1.22
          cache: true   # âœ… Caches Go modules automatically

      # -------------------------------
      # 3. Build Go binary
      # -------------------------------
      - name: Build
        working-directory: src/product-catalog
        run: |
          go mod download
          go build -o product-catalog-service main.go

      # -------------------------------
      # 4. Run unit tests
      # -------------------------------
      - name: Unit tests
        working-directory: src/product-catalog
        run: |
          go test ./...

      # -------------------------------
      # 5. Cache Trivy vulnerability DB
      # -------------------------------
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}

      # -------------------------------
      # 6. Trivy filesystem scan
      # -------------------------------
      - name: Trivy FS Scan
        working-directory: src/product-catalog
        run: |
          trivy fs . \
            --severity HIGH,CRITICAL \
            --format table \
            --output trivy-fs-report.txt \
            --no-progress

      - name: Upload Trivy FS report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: src/product-catalog/trivy-fs-report.txt

      # -------------------------------
      # 7. Setup Docker Buildx
      # -------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------
      # 8. Login to Docker Hub
      # -------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------------
      # 9. Build & Push Docker image (WITH CACHE)
      # -------------------------------
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: src/product-catalog
          file: src/product-catalog/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog:${{ github.run_id }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -------------------------------
      # 10. Trivy Docker image scan
      # -------------------------------
      - name: Trivy Docker Image Scan
        run: |
          trivy image \
            ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog:${{ github.run_id }} \
            --severity HIGH,CRITICAL \
            --format table \
            --output trivy-image-report.txt \
            --no-progress

      - name: Upload Trivy Docker Image report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.txt
